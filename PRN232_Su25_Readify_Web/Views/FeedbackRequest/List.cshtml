@page
@{
}
<style>
    .btn[disabled] {
        cursor: not-allowed !important;
    }
</style>
<h2 style="text-align: center; margin-top: 20px; margin-bottom: 20px;">Contribute requests</h2>

<table id="contributeTable" class="display" style="width:100%; margin-top: 200px;">
    <thead>
        <tr>
            <th>No</th>
            <th>User Name</th>
            <th>Subject</th>
            <th>Message</th>
            <th>Response</th>
            <th>Created At</th>
            <th>Action</th>
        </tr>
    </thead>
</table>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<!-- Include Bootstrap CSS & JS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<!-- Modal -->
<div class="modal fade" id="responseModal" tabindex="-1" aria-labelledby="responseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="responseModalLabel">Respond to Contribute Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>User Name:</strong> <span id="modalUserName"></span></p>
                <p><strong>Subject:</strong> <span id="modalSubject"></span></p>
                <p><strong>Message:</strong></p>
                <p id="modalMessage"></p>
                <div class="mb-3">
                    <label for="responseText" class="form-label">Your Response</label>
                    <textarea class="form-control" id="responseText" rows="4" required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <input type="hidden" id="modalContributeId">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="sendResponseBtn">Send</button>
            </div>
        </div>
    </div>
</div>

<script>
        function loadPaymentDataTable() {
          $('#contributeTable').DataTable({
            destroy: true,
            ajax: {
              url: 'https://localhost:7267/api/FeedbackRequests',
              dataSrc: ''
            },
            columns: [
              {
                  data: 'id',
                  render: function (data, type, row, meta) {
                        return `<span class="text-center fw-bold">${meta.row + 1}</span>`;
                  }
              },
              { data: 'userName' },
              { data: 'subject' },
              { data: 'message' },
              {data: 'response'},
              {
              data: 'createDate',
                  render: function (data, type, row) {
                    const date = new Date(data);
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0'); // months are 0-based
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                  }
              },
              {
                data: null,
                className: 'text-center',
                render: function (data, type, row) {
                    return `
                      <button class="btn btn-success btn-sm response-btn" data-id="${row.id}" data-username="${row.userName}"
                      data-subject="${row.subject}" data-message="${row.message}" data.Response=${row.response} title="Response">
                        Response
                      </button>
                    `;
                }
              }
            ]
          });
        }

        // Call on page load
        $(document).ready(function () {
          loadPaymentDataTable();
          $('#contributeTable').on('click', '.response-btn', function () {
            const id = $(this).data('id');
            const userName = $(this).data('username');
            const subject = $(this).data('subject');
            const message = $(this).data('message');

            $('#modalContributeId').val(id);
            $('#modalUserName').text(userName);
            $('#modalSubject').text(subject);
            $('#modalMessage').text(message);
            $('#responseText').val('');

            const modal = new bootstrap.Modal(document.getElementById('responseModal'));
            modal.show();
        });

        $('#sendResponseBtn').on('click', function () {
            const contributeId = $('#modalContributeId').val();
            const response = $('#responseText').val().trim();

            if (!response) {
                alert("Response cannot be empty!");
                return;
            }

            fetch('https://localhost:7267/api/FeedbackRequests/response', {
                method: 'PUT',
                credentials: "include",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: parseInt(contributeId),
                    response: response
                })
            })
            .then(res => {
                if (!res.ok) throw new Error("Failed to send response");
                return res;
            })
            .then(data => {
                $('#responseModal').modal('hide');
                $('#contributeTable').DataTable().ajax.reload(null, false);
                Swal.fire({
                    icon: 'success',
                    title: 'Response Sent',
                    text: 'Your response has been sent successfully!'
                });
            })
            .catch(error => {
                console.error(error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to send response. Please try again later.'
                });
            });
        });
        });
</script>
