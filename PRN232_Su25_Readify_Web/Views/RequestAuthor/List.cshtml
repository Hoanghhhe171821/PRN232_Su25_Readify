@*
    Enhanced Author Requests UI with SweetAlert2 and DataTables
*@
@{
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Author Requests</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="p-4 bg-light">
    <div class="container">
        <h2 class="mb-4">Author Requests</h2>
        <table class="table table-bordered table-striped" id="requestsTable">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Reason</th>
                    <th>Bank Account</th>
                    <th>Status</th>
                    <th>Created Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <!-- Include Bootstrap CSS & JS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script>
        const apiUrl = "https://localhost:7267/api/RequestAuthors";

        // Load data into DataTable
        function loadRequests() {
            $.get(apiUrl, function (data) {
                const table = $("#requestsTable").DataTable();
                table.clear();

                data.forEach((item) => {
                    const status = item.isApproved === 0
                        ? "Pending"
                        : item.isApproved === 1
                            ? "Approved"
                            : "Declined";
                    const isDisabled = item.isApproved !== 0;

                    const row = [
                        item.id,
                        item.username,
                        item.reason,
                        item.bankAccount,
                        status,
                        new Date(item.createdDate).toLocaleString(),
                        `
                        <button class="btn btn-success btn-sm me-1" onclick="confirmAction(${item.id}, 1)" ${isDisabled ? "disabled" : ""}>Approve</button>
                        <button class="btn btn-danger btn-sm" onclick="confirmAction(${item.id}, -1)" ${isDisabled ? "disabled" : ""}>Decline</button>
                        `
                    ];
                    table.row.add(row);
                });

                table.draw();
            });
        }

        // Show Swal confirmation then send update
        function confirmAction(id, isApproved) {
            Swal.fire({
                title: isApproved == 1 ? "Approve Request?" : "Decline Request?",
                icon: "question",
                showCancelButton: true,
                confirmButtonText: isApproved == 1 ? "Approve" : "Decline",
                cancelButtonText: "Cancel",
                confirmButtonColor: isApproved == 1 ? "#198754" : "#dc3545",
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: apiUrl,
                        method: "PUT",
                        contentType: "application/json",
                        xhrFields: {
                            withCredentials: true
                        },
                        data: JSON.stringify({
                            id: id,
                            isApproved: isApproved,
                            reason: "" // optional if backend needs
                        }),
                        success: function () {
                            Swal.fire({
                                icon: "success",
                                title: isApproved == 1 ? "Approved" : "Declined",
                                showConfirmButton: false,
                                timer: 1500
                            });
                            loadRequests();
                        },
                        error: function () {
                            Swal.fire({
                                icon: "error",
                                title: "Failed",
                                text: "There was an error updating the request."
                            });
                        }
                    });
                }
            });
        }

        // Initialize DataTable and load
        $(document).ready(function () {
            $("#requestsTable").DataTable({
                responsive: true,
                columns: [
                    { title: "ID" },
                    { title: "Username" },
                    { title: "Reason" },
                    { title: "Bank Account"},
                    { title: "Status" },
                    { title: "Created Date" },
                    { title: "Actions", orderable: false }
                ],
                language: {
                    search: "Filter:",
                    lengthMenu: "Show _MENU_ entries",
                    info: "Showing _START_ to _END_ of _TOTAL_ requests",
                    paginate: {
                        previous: "Previous",
                        next: "Next"
                    }
                }
            });

            loadRequests();
        });
    </script>
</body>
</html>
